
weatherAutocomplete={searchTerm:'',existingResults:'',measurements:{metric:{temperature:{abbr:'&#8451;',title:'degrees Celcius'},minTemp:{abbr:'&#8451;',title:'degrees Celcius'},maxTemp:{abbr:'&#8451;',title:'degrees Celcius'},windSpeed:{abbr:'mps',title:'meters per second'},windDirection:{abbr:'&deg;',title:'degrees'},pressure:{abbr:'hPa/mbar',title:'hectopascal/millibar'},rain:{abbr:'mm',title:'millimeters per 3 hours'}},imperial:{temperature:{abbr:'&#8457;',title:'degrees Fahrenheit'},minTemp:{abbr:'&#8451;',title:'degrees Celcius'},maxTemp:{abbr:'&#8451;',title:'degrees Celcius'},windSpeed:{abbr:'fps',title:'feet per second'},pressure:{abbr:'hPa/mbar',title:'hectopascal/millibar'},rain:{abbr:'&ldquo;',title:'inches per 3 hours'}}},defaults:{searchElement:'#weatherSearchInput',minSearchCharacters:3,apiKey:'e12d6c5a83c260d4fa6a27de5f923145',measurementType:'metric',displayFormat:'{city}, {countryCode} {icon} ({temperature})'},overrideDefaults:function(overrides){for(var prop in weatherAutocomplete.defaults){if(overrides.hasOwnProperty(prop)){weatherAutocomplete.defaults[prop]=overrides[prop];}}},init:function(defaultOverrides){this.overrideDefaults(defaultOverrides);$('body').on('keyup',weatherAutocomplete.defaults.searchElement,function(el){if(el.keyCode==40){weatherAutocomplete.focusNextItem(el);return;}
if(el.keyCode==38){weatherAutocomplete.focusPreviousItem(el);return}
if(el.keyCode==13){weatherAutocomplete.selectItem(el);return;}
var searchTerm=$(this).val();weatherAutocomplete.setSearchTerm(searchTerm);weatherAutocomplete.filterResults();$('body').on('click','.weatherSearchResultItem',function(){weatherAutocomplete.setCity($(this).attr('data-city'));});})},focusNextItem:function(el){if($('li.focus').length==0){this.focusItem($('#weatherSearchResults li').first());}else{this.focusItem($('li.focus').next());this.unfocusItem($('li.focus').first());}},focusPreviousItem:function(el){if($('li.focus').length>0){this.focusItem($('li.focus').prev());this.unfocusItem($('li.focus').last());}else{this.focusItem($('#weatherSearchResults li').last());}},selectItem:function(el){var selected=$('li.focus').first();weatherAutocomplete.setCity(selected.attr('data-cityName'));$(weatherAutocomplete.defaults.searchElement).attr('data-city_id',selected.attr('data-city_id')).attr('data-cityName',selected.attr('data-cityName')).attr('data-countryCode',selected.attr('data-countryCode')).attr('data-temperature',selected.attr('data-temperature')).attr('data-min_temp',selected.attr('data-min_temp')).attr('data-max_temp',selected.attr('data-max_temp')).attr('data-windSpeed',selected.attr('data-windSpeed')).attr('data-windDirection',selected.attr('data-windDirection')).attr('data-cloudCoverage',selected.attr('data-cloudCoverage')).attr('data-longitude',selected.attr('data-longitude')).attr('data-latitude',selected.attr('data-latitude')).attr('data-humidity',selected.attr('data-humidity')).attr('data-pressure',selected.attr('data-pressure')).attr('data-rain',selected.attr('data-rain')).attr('data-description',selected.attr('data-description')).attr('data-shortDescription',selected.attr('data-shortDescription')).attr('data-icon',selected.attr('data-icon'))},focusItem:function(el){el.addClass('focus');},unfocusItem:function(el){el.removeClass('focus');},countChars:function(){return this.searchTerm.length;},queryWeatherAPI:function(){$.ajax({url:weatherAutocomplete.formatSearchURL(),type:'POST',success:function(reply){weatherAutocomplete.setResults(reply.list);weatherAutocomplete.convertResultsIntoListItems();},error:function(reply){console.warn("There was an error");console.dir(reply);}});},setResults:function(list){this.existingResults=list;},convertResultsIntoListItems:function(){var ul=this.buildResultsContainer();if($('#weatherSearchResults').css('display')=='none'){$('#weatherSearchResults').slideDown();}
var r=this.existingResults;for(var i=0;i<r.length;i++){var city=r[i].name;var city_id=r[i].id;var temperature=r[i].main.temp;var icon=r[i].weather[0].icon;var windSpeed=r[i].wind.speed;var windDirection=r[i].wind.deg;var clouds=r[i].clouds.all;var countryCode=r[i].sys.country;var humidity=r[i].main.humidity;var pressure=r[i].main.pressure;var minTemp=r[i].main.temp_min;var maxTemp=r[i].main.temp_max;var coordsLat=r[i].coord.lat;var coordsLon=r[i].coord.lon;var description=r[i].weather[0].description;var shortDescription=r[i].weather[0].main;ul.append('<li></li>');var value=weatherAutocomplete.displayFormat({cityName:city,city_id:city_id,temperature:temperature,icon:icon,windSpeed:windSpeed,windDirection:windDirection,clouds:clouds,countryCode:countryCode,humidity:humidity,pressure:pressure,minTemp:minTemp,maxTemp:maxTemp,latitude:coordsLat,longitude:coordsLon,description:description,shortDescription:shortDescription});var li=$('#weatherSearchResults li:last-child').addClass('weatherSearchResultItem').attr('id','weatherSearchResultItem_'+r[i].id).attr('data-cityName',city).attr('data-city_id',city_id).attr('data-temperature',temperature).attr('data-icon',icon).attr('data-windSpeed',windSpeed).attr('data-windDirection',windDirection).attr('data-cloudCoverage',clouds).attr('data-countryCode',countryCode).attr('data-humidity',humidity).attr('data-pressure',pressure).attr('data-minTemp',minTemp).attr('data-maxTemp',maxTemp).attr('data-latitude',coordsLat).attr('data-longitude',coordsLon).attr('data-description',description).attr('data-shortDescription',shortDescription).html(value);}},buildResultsContainer:function(){if($('#weatherSearchResults').length==1){$('#weatherSearchResults li').each(function(){this.remove();});return $('#weatherSearchResults');}
var parent=$(weatherAutocomplete.defaults.searchElement).parent();parent.append('<ul></ul>');var ul=parent.find('ul');ul.addClass('autocompleteResults').attr('id','weatherSearchResults').css('width',$(this.defaults.searchElement).parent().width()+"px").css('top',$(this.defaults.searchElement).parent().height()+"px");return $('#weatherSearchResults');},filterResults:function(){if(this.countChars()<=(this.defaults.minSearchCharacters-1)){return null;}
this.queryWeatherAPI();},formatSearchURL:function(){var baseURL='http://api.openweathermap.org/data/2.5/find?',format='json',metric='metric',accuracy='like';apiKey=weatherAutocomplete.defaults.apiKey;var url=baseURL+'q='+this.searchTerm+'&mode='+format+'&units='+metric+'&type='+accuracy+'&APPID='+apiKey;return url;},setSearchTerm:function(searchTerm){this.searchTerm=searchTerm;},setCity:function(city){$(this.defaults.searchElement).val(city);this.hideAutocomplete();return false;},hideAutocomplete:function(){$('#weatherSearchResults').slideUp();},displayFormat:function(data){var replacement;var formatRequired=weatherAutocomplete.defaults.displayFormat;while(formatRequired.indexOf('{')>=0){var dataToReplace=formatRequired.substring(formatRequired.indexOf('{')+1,(formatRequired.indexOf('}')));switch(dataToReplace){case'temperature':case'windSpeed':case'windDirection':case'minTemp':case'maxTemp':case'pressure':replacement=weatherAutocomplete.formatMeasurement(data[dataToReplace].toString(),weatherAutocomplete.measurements[weatherAutocomplete.defaults.measurementType][dataToReplace].abbr,weatherAutocomplete.measurements[weatherAutocomplete.defaults.measurementType][dataToReplace].title);break;case'humidity':case'clouds':replacement=data[dataToReplace]+'&#37;';break;case'icon':var replacement='<span class="weatherIcon_'+data.icon+' weatherIcon">&nbsp;</span>';break;case'latitude':case'longitude':case'countryCode':case'cityName':case'description':case'shortDescription':default:replacement=data[dataToReplace];}
var re=new RegExp("{"+dataToReplace+"}");formatRequired=formatRequired.replace(re,replacement);}
return formatRequired;},formatMeasurement:function(value,abbr,title){return value.toString()+' <abbr title="'+title+'">'+abbr+'</abbr>';}};function initialiseAutocompleteWithWeather(defaultOverrides){weatherAutocomplete.init(defaultOverrides);}